/*! scbone - v0.0.1 - 2013-11-08 */
!function(a){"use strict";"object"==typeof exports?module.exports=a(require("underscore")):"function"==typeof define&&define.amd&&define(["underscore"],a)}(function(_){"use strict";var a={};return a["SCBone/profile"]=_.template(["",'<% var prefix = "#"+ (routePrefix ? routePrefix +"/" : ""); %>','<div class="block-h">','<a href="<%- prefix %>host" class="picture">','<img src="<%- host.avatar_url %>" alt="<%- host.username %>" />',"</a>",'<div class="info">','<a href="<%- prefix %>host" class="username"><%- host.username %></a>','<span class="full-name"><%- host.full_name %></span>','<span class="city"><%- host.city %></span><%= (host.country && host.city ? "," : "") %>','<span class="country"><%- host.country %></span>',"</div>","</div>",'<ul class="subresources">',"<li>",'<a href="<%- prefix %>host/favorites">','<i class="icon-heart"></i>','<span><%- (host.public_favorites_count || "") %></span>',"Likes","</a>","</li>","<li>",'<a href="<%- prefix %>host/tracks">','<i class="icon-mic"></i>',"<span><%- (host.track_count || 0) %></span>","Tracks","</a>","</li>","<li>",'<a href="<%- prefix %>host/followings">','<i class="icon-angle-left"></i>',"<span><%- (host.followings_count || 0) %></span>","Followings","</a>","</li>","<li>",'<a href="<%- prefix %>host/followers">','<i class="icon-angle-right"></i>',"<span><%- (host.followers_count || 0) %></span>","Followers","</a>","</li>","</ul>",'<div class="description"><%- host.description %></div>',""].join("\n")),a["SCBone/app"]=_.template(["",'<div class="host-sc-profile"></div>','<div class="player"></div>',""].join("\n")),a["SCBone/player"]=_.template(["",'<% var prefix = "#"+ (routePrefix ? routePrefix +"/" : ""); %>','<div class="progress"><canvas /></div>','<div class="controls"></div>','<div class="logos">','<a class="soundcloud" href="http://soundcloud.com" title="powered by Soundcloud">powered by Soundcloud</a>',"</div>",'<section class="list tracks"><ul></ul></section>',""].join("\n")),a["SCBone/controls"]=_.template(["",'<% var prefix = "#"+ (routePrefix ? routePrefix +"/" : ""); %>','<div class="playback">','<button class="prev icon-prev"><i class="icon-angle-double-left"></i></button>','<button class="next icon-next"><i class="icon-angle-double-right"></i></button>',"</div>",""].join("\n")),a["SCBone/trackItem"]=_.template(["","<%",'var prefix = "#"+ (routePrefix ? routePrefix +"/" : "");','var likes = (typeof favoritings_count !== "undefined" ? favoritings_count : 0);','var user_liked = (typeof user_favorite !== "undefined" && user_favorite);',"%>",'<li<%= (artwork_url ? "" : " class=\\"no-artwork\\"") %>>',"<% if(artwork_url) { %>",'<img class="artwork" src="<%- artwork_url %>">',"<% } %>",'<div class="track-info <%- sharing %>">','<div class="title">','<a href="<%- prefix %>tracks/<%- id %>"><%- title %></a>',"</div>",'<span class="duration">','<i class="icon-clock"></i>','<%- moment(duration).format("m:s") %>',"</span>",'<span class="likes"','<%= (user_liked ? " title=\\"You liked it.\\"" : "") %>',">",'<i class="icon-heart<%- (user_liked ? "" : "-empty") %>"></i>',"<%- likes %>","</span>",'<a href="<%- prefix %>users/<%- user.permalink %>" class="username">',"<%- user.username %>","</a>",'<% if (sharing === "private") { %>',"<% } %>","</div>","</li>",""].join("\n")),a["SCBone/userItem"]=_.template(["",'<% var prefix = "#"+ (routePrefix ? routePrefix +"/" : ""); %>','<li<%= (artwork_url ? "" : " class=\\"no-artwork\\"") %>>',"<% if(artwork_url) { %>",'<img class="artwork" src="<%- artwork_url %>">',"<% } %>",'<div class="track-info">','<div class="title">','<a href="<%- prefix %>tracks/<%- id %>"><%- title %></a>',"</div>",'<span class="duration">','<i class="icon-clock"></i>','<%- moment(duration).format("m:s") %>',"</span>",'<% if(typeof favoritings_count !== "undefined") { %>','<span class="favorited"><%- favoritings_count %></span>',"<% } %>",'<a href="<%- prefix %>users/<%- user.permalink %>" class="username">',"<%- user.username %>","</a>","</div>","</li>",""].join("\n")),a["SCBone/track"]=_.template(["",'<% var prefix = "#"+ (routePrefix ? routePrefix +"/" : ""); %>',"<header>",'<a href="<%- prefix %>tracks/<%- id %>" class="title"><%- title %></a>','<span class="duration"><i class="icon-clock"></i><%- moment(duration).format("m:s") %></span>','<span class="likes"><i class="icon-heart"></i><%- favoritings_count %></span>','<span class="user">','<a href="<%- prefix %>users/<%- user.permalink %>" class="username"><%- user.username %></a>','<span class="full-name"><%- user.full_name %></span>',"</span>",'<% if (typeof label !== "undefined") { %>','<span class="label">','<a href="<%- prefix %>users/<%- label.permalink %>" class="username"><%- label.username %></a>','<span class="full-name"><%- label.full_name %></span>',"</span>","<% } %>","</header>",'<div class="description"><%= description %></div>',"<footer>","</footer>",""].join("\n")),"undefined"!=typeof window&&window.JST&&_.defaults(window.JST,a),a}),function(a){"use strict";"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd&&define([],a)}(function(){"use strict";function a(a){return function(b,d,e){var f=e.success||c,g=(e.error||c,a+":");switch(g+=d.id?d.id:"#"+d.cid,b){case"create":case"update":case"patch":localStorage.setItem(g,JSON.stringify(d.toJSON()));break;case"read":f(JSON.parse(localStorage.getItem(g)));break;case"delete":}}}function b(a){a=a||{};var b=this,d=a.success||c,e=a.error||c,f=b.get("permalink")||b.id;console.info("permalink for fetching",f,b.toJSON());var g="/"+_.result(b,"url")+"/"+f;if(!a.subresource)return SC.get(g,function(a,c){b.set(a),d.call(b,a,c)}),void 0;g=g+"/"+a.subresource;var h=b.constructor.subresources,i=h[a.subresource];if(!i)throw new Error("No subresource found for"+a.subresource);require([i],function(c){var e=b[a.subresource];e||(e=b[a.subresource]=new c,b.listenTo(e,"change",function(){b.trigger("change:"+a.subresource,b,{subresource:a.subresource}),b.trigger("change",b,{subresource:a.subresource})})),SC.get(g,function(a,c){var f=_.isUndefined(b.length)?"set":"reset";e[f](a,{silent:!0}),e.trigger("change",e,{}),d.call(b,a,c)})},e)}var c=function(){},d={fetch:b,localSync:a};return d}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("underscore"),require("backbone"),null,require("./templates"),require("./collections/users"),require("./collections/tracks"),require("./views/profile"),require("./templates/player")):"function"==typeof define&&define.amd?define(["underscore","backbone","//connect.soundcloud.com/sdk.js","./templates","./collections/users","./collections/tracks","./collections/local-playlist","./views/profile","./views/player"],a):"undefined"!=typeof _&&"undefined"!=typeof Backbone&&(window.SCBone=a(_,Backbone))}(function(_,Backbone,a,b,c,d,e,f,g){function h(a){a&&localStorage.setItem("scbone-access-token",a);var b=localStorage.getItem("scbone-access-token");return console.info("scAccessToken",a,b),b}var i,j=Backbone.$,k=c.prototype.model,l=d.prototype.model,m="track user comment group followers followings tracks users comments groups",n=Backbone.Router.extend({routePrefix:"step/sounds",routes:{"":"appStart","users/:id(/:subresource)":"guestAction","host/:subresource":"hostAction","tracks/:id":"playTrack",connect:"scConnect"},appStart:function(){},playTrack:function(a){a=parseInt(a,10);var b=this,c=this.player.collection;c.get(a)?this.player.setCurrentById(a):SC.get("/tracks/"+a,function(d){c.add(d),b.playTrack(a),b.player.playPause()})},hostAction:function(a){console.info("SC router host",this.host.get("username"),a),this.host.fetch({subresource:a})},guestAction:function(a,b){console.info("SC router guest",a,b);var c=this.guest;c.id!==a?(c.attributes={},c.attributes[c.idAttribute]=a,c.id=a,c.fetch({success:function(){console.info("guest user loaded",c),b&&c.fetch({subresource:b})}})):b&&c.fetch({subresource:b})},scConnect:function(){var a=this;if(console.info("connecting to SoundCloud",!!i),!i){i=!0;var b=h();b?(SC.accessToken(b),a.scConnected()):SC.connect(function(){h(SC.accessToken()),a.scConnected()})}},scConnected:function(){var a=this;SC.get("/me",function(b){console.info("connected",b.username),a.guest.set(a.host.toJSON()),a.host.set(b),a.host.once("change:favorites",function(){a.player.collection.set(a.host.favorites.toJSON()),a.player.collection.setCurrent(0),a.player.tracksRender()}),a.host.fetch({subresource:"favorites"}),a.player.render()})},scIsConnected:function(){return!!h()},setScope:function(a){return this.$el.removeClass(m),a&&this.$el.addClass(a),this},initialize:function(a){var c=this;c.el=a.el,c.$el=j(c.el),c.routePrefix=a.routePrefix;var d='[href^="/"]';a.routePrefix&&(d='[href^="'+a.routePrefix+'"],[href^="/'+a.routePrefix+'"],[href^="#'+a.routePrefix+'"]'),j(document).delegate(d,"click",function(){var a=j(this).attr("href"),b=a.substr(0,1);return a="/"===b||"#"===b?a.substr(1):a,c.navigate(a,{trigger:!0}),!1}),SC.initialize({client_id:a.clientid,redirect_uri:a.callbackurl}),c.localPlaylist=new e([],{}),c.host=new k({permalink:a.hostpermalink}),j(c.el).html(b["SCBone/app"],{routePrefix:c.routePrefix}),c.profile=new f({model:c.host,el:j(".host-sc-profile",a.el)[0],router:c}),c.profile.render(),c.player=new g({el:j(".player",a.el)[0],collection:c.localPlaylist,router:c}),c.player.render(),c.host.on("change",function(a,b){b=b||{};var d,e=b.subresource;("favorites"===e||"tracks"===e)&&(d="tracks",c.player.collection.set(c.host[b.subresource].toJSON()),c.player.render({scope:d})),c.setScope(d)}),c.host.fetch({}),c.guest=new k({})}},{Models:{User:k,Track:l},Collections:{User:c,Track:d,LocalPlaylist:e},Views:{Profile:f}});return n}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("underscore"),require("backbone"),require("./../mixins")):"function"==typeof define&&define.amd&&define(["underscore","backbone","./../mixins"],a)}(function(_,Backbone,a){var b=Backbone.Model.extend({fetch:a.fetch},{subresources:{}});return b}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("./base-model")):"function"==typeof define&&define.amd&&define(["./base-model"],a)}(function(a){var b=a.extend({url:"comments"});return b}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("./base-model")):"function"==typeof define&&define.amd&&define(["./base-model"],a)}(function(a){var b=a.extend({url:"groups"},{subresources:{users:"apps/soundcloud/collections/users",moderators:"apps/soundcloud/collections/users",members:"apps/soundcloud/collections/users",contributors:"apps/soundcloud/collections/users",tracks:"apps/soundcloud/collections/tracks"}});return b}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("./base-model")):"function"==typeof define&&define.amd&&define(["./base-model"],a)}(function(a){var b=a.extend({url:"playlists"},{subresources:{}});return b}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("./base-model")):"function"==typeof define&&define.amd&&define(["./base-model"],a)}(function(a){var b=a.extend({url:"tracks"},{subresources:{user:"apps/soundcloud/models/user",favoriters:"apps/soundcloud/collections/users",comments:"apps/soundcloud/collections/comments"}});return b}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("./base-model")):"function"==typeof define&&define.amd&&define(["./base-model"],a)}(function(a){var b=a.extend({url:"users"},{subresources:{comments:"apps/soundcloud/collections/comments",favorites:"apps/soundcloud/collections/tracks",tracks:"apps/soundcloud/collections/tracks",followings:"apps/soundcloud/collections/users",followers:"apps/soundcloud/collections/users"}});return b}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("underscore"),require("backbone"),require("./../models/comment")):"function"==typeof define&&define.amd&&define(["underscore","backbone","./../models/comment"],a)}(function(_,Backbone,a){var b=Backbone.Collection.extend({model:a,initialize:function(){}});return b}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("underscore"),require("backbone"),require("./../models/group")):"function"==typeof define&&define.amd&&define(["underscore","backbone","./../models/group"],a)}(function(_,Backbone,a){var b=Backbone.Collection.extend({model:a});return b}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("underscore"),require("backbone"),require("./tracks"),require("./../models/track")):"function"==typeof define&&define.amd&&define(["underscore","backbone","./tracks","./../models/track","./../mixins"],a)}(function(_,Backbone,a,b,c){var d=function(){},e=b.extend({initialize:function(){this.fetch()},fetch:Backbone.Model.prototype.fetch,sync:c?c.localSync("local-playlist"):d}),f=a.extend({model:e,saveOrder:function(){return c&&localStorage.setItem("local-playlist-sorting",this.pluck("id").join()),this},loadOrder:function(){return c&&localStorage.getItem("local-playlist-sorting").split(","),this},initialize:function(){this.on("all",function(a){console.info("evName on local playlist",a)}),this.on("sort",function(){})}});return f}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("underscore"),require("backbone"),require("./../models/playlist")):"function"==typeof define&&define.amd&&define(["underscore","backbone","./../models/playlist"],a)}(function(_,Backbone,a){var b=Backbone.Collection.extend({model:a});return b}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("underscore"),require("backbone"),require("./../models/track")):"function"==typeof define&&define.amd&&define(["underscore","backbone","./../models/track"],a)}(function(_,Backbone,a){var b=Backbone.Collection.extend({model:a,initialize:function(a,b){b=b||{},this.current=!1},setCurrent:function(a){if(a=parseInt(a||0,10),console.info("setCurrent index",a),this.current===a&&a!==!1)return this;this.current=a;var b;return this.each(function(c,d){var e=c.get("current");e&&d!==a?c.set("current",!1):e||d!==a||c.set("current",!0),d===a&&(b=c.id)}),this.trigger("current-track",this,a,b),this},setCurrentById:function(a){return this.setCurrent(this.indexById(a))},indexById:function(a){var b=!1;return this.each(function(c,d){b===!1&&c.id===a&&(b=d)}),console.info("index for "+a,b),b},getCurrent:function(){return this.at(this.current)},previous:function(){return this.current>0?this.setCurrent(this.current-1):this.setCurrent(this.length-1)},next:function(){return this.current>=this.length-1?this.setCurrent(0):this.setCurrent(this.current+1)}});return b}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("underscore"),require("backbone"),require("./../models/user")):"function"==typeof define&&define.amd&&define(["underscore","backbone","./../models/user"],a)}(function(_,Backbone,a){var b=Backbone.Collection.extend({model:a});return b}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("underscore"),require("backbone"),require("./../templates"),require("moment")):"function"==typeof define&&define.amd&&define(["underscore","backbone","./../templates","moment"],a)}(function(_,Backbone,a){"use strict";var b=Backbone.$,c=Backbone.View.extend({events:{"click .progress":"playPause","click .prev":"previousTrack","click .next":"nextTrack","click .tracks .title":"playTrack","click .modal .underlay":"modalClose","click .tracks likes":"like"},initialize:function(c){var d=this;d.router=c.router,d.sound=null,d.trackId=null,d.listenTo(d.collection,"change",d.render),d.listenTo(d.collection,"current-track",function(a,b,c){if(console.info("current-track event on collection",c,b),d.trackId!==c){d.trackId=c,c&&d.drawProgress().trigger("current-track",c),d.$(".tracks li").removeClass("current").eq(b).addClass("current");var e=68*Math.max(0,b-1)+8*Math.max(0,b-1);d.$(".tracks").scrollTo(e)}}),d.on("current-track",function(a){var b=d.collection.get(a);d.artwork=!1;var c=b.get("artwork_url");if(c){var e=new Image;e.onload=function(){d.artwork=e,d.drawProgress()},e.src=c}SC.stream("/tracks/"+a,function(a){d.sound&&d.sound.destruct(),d.sound=a,a.play({onfinish:function(){d.nextTrack()},whileplaying:function(){a.playState&&d.drawProgress(a.position/b.get("duration")*100)}})}),d.render()}),d.$el.html(a["SCBone/player"]({currentTrack:{},routePrefix:this.router.routePrefix})),d.$canvas=b("<canvas />"),d.$(".progress").append(d.$canvas),d.ctx=d.$canvas[0].getContext("2d"),d.$tracks=this.$(".tracks ol"),d.trackTemplate=d.$tracks.html(),d.$tracks.empty()},playPause:function(a){var b,c=this.collection.getCurrent();if(a&&a.offsetX&&a.offsetY){var d=this.$("canvas");if(d.length){var e=d[0].width,f=d[0].height;b=a.offsetX>=e/2-17&&a.offsetX<=e/2+17&&a.offsetY>=f/2-17&&a.offsetY<=f/2+17}}if(this.sound){if(b){var g=this.$(".progress");this.sound.paused?(this.sound.play(),g.addClass("playing")):(this.sound.pause(),g.removeClass("playing"))}}else c&&this.trigger("current-track",c.id);return a?!1:this},playTrack:function(a){if(a){var c=b(a.target).attr("href").split("/").pop();return c=parseInt(c,10),this.setCurrentById(c),!1}},getCurrent:function(){return this.collection.getCurrent()},setCurrent:function(a){return this.collection.setCurrent(a)},setCurrentById:function(a){return this.setCurrent(this.indexById(a))},indexById:function(a){return this.collection.indexById(a)},previousTrack:function(a){return this.collection.previous(),a?!1:this},nextTrack:function(a){return this.collection.next(),a?!1:this},drawProgress:function(a){function b(){var a=h/2,b=g/2;f.fillStyle=k,f.beginPath(),f.moveTo(b-6,a-12),f.lineTo(b+8,a),f.lineTo(b-6,a+12),f.lineTo(b-6,a-12),f.closePath(),f.fill()}function c(){var a=h/2,b=g/2;f.fillStyle=k,f.fillRect(b-9,a-9,6,18),f.fillRect(b+3,a-9,6,18)}if(this.sound&&!this.sound.playState)return this;a=a||0;Math.round(100*a);a=3.6*a;var d=this.$("canvas");if(!d.length)return this;var e=this.$(".progress"),f=d[0].getContext("2d"),g=d[0].width=e.width(),h=d[0].height=e.height(),i=0,j="rgba(255, 255, 255, 0.4)",k="rgba(0, 0, 0, 0.8)";return this.artwork&&f.drawImage(this.artwork,i,i,g-2*i,h-2*i),f.beginPath(),f.lineWidth=32,f.strokeStyle=j,f.arc(.5*g,.5*h,(Math.min(g,h)-64)/2,0,Math.PI/180*360),f.stroke(),f.closePath(),this.sound&&(f.beginPath(),f.lineWidth=16,f.strokeStyle=k,f.arc(.5*g,.5*h,(Math.min(g,h)-64)/2,Math.PI/180*-90,Math.PI/180*(a-90)),f.stroke(),f.closePath()),f.fillStyle=j,f.fillRect(g/2-17,h/2-17,34,34),!this.sound||this.sound.paused?(e.removeClass("playing"),b()):(e.addClass("playing"),c()),this},render:function(b){b=b||{};var c=this.getCurrent();return this.$(".controls").html(a["SCBone/controls"]({currentTrack:c?c.toJSON():{},routePrefix:this.router.routePrefix})),this.drawProgress(),b.scope&&_.isFunction(this[b.scope+"Render"])&&this[b.scope+"Render"](b),this},tracksRender:function(b){b=b||{};var c=this,d=b.collection||c.collection,e=d.map(function(b){var d=b.toJSON();return d.routePrefix=c.router.routePrefix,a["SCBone/trackItem"](d)});return c.$(".tracks ul").html(e.join("")),c},usersRender:function(b){b=b||{};var c=this;if(b.collection){var d=b.collection.map(function(b){var d=b.toJSON();return d.routePrefix=c.router.routePrefix,a["SCBone/userItem"](d)});c.$(".users ul").html(d.join(""))}return c},modal:function(a){return this.$modal=this.$(".modal"),this.$modal.length||(this.$modal=b('<div class="modal"><div class="underlay"></div><div class="content"></div></div>'),this.$el.append(this.$modal)),this.$modal.find(".content").addClass("open").empty()[_.isString(a)?"html":"append"](a),this},modalAsk:function(){var a=b();return this.modal(a)},modalClose:function(){return this.$modal.removeClass("open"),this}});return c}),function(a){"use strict";"object"==typeof exports?module.exports=a(require("underscore"),require("backbone"),require("./../templates")):"function"==typeof define&&define.amd&&define(["underscore","backbone","./../templates"],a)}(function(_,Backbone,a){"use strict";var b=Backbone.View.extend({events:{"click .sc-connect":"connect"},connect:function(a){return this.router.scConnect(),a?!1:void 0},initialize:function(a){this.router=a.router,this.listenTo(this.model,"change",this.render)},render:function(){var b={};return b.host=this.model.toJSON(),b.routePrefix=this.router.routePrefix,this.$el.html(a["SCBone/profile"](b)),this}});return b});